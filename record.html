<!DOCTYPE html>
<html lang="en">

<head>
    <title>Record</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--===============================================================================================-->
    <link rel="icon" type="image/png" href="images/icons/favicon.ico" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="vendor/bootstrap/css/bootstrap.min.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="fonts/font-awesome-4.7.0/css/font-awesome.min.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="fonts/iconic/css/material-design-iconic-font.min.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="vendor/animate/animate.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="vendor/css-hamburgers/hamburgers.min.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="vendor/animsition/css/animsition.min.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="vendor/select2/select2.min.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="vendor/daterangepicker/daterangepicker.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="css/util.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <link rel="stylesheet" type="text/css" href="css/start-conv.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
    <style>
        .Blink {
            animation: blinker 1.5s cubic-bezier(.5, 0, 1, 1) infinite alternate;
        }
    
        @keyframes blinker {
            from {
                opacity: 1;
            }
    
            to {
                opacity: 0;
            }
        }
    
        input[type="file"] {
            display: none;
        }
    
        .custom-file-upload {
            padding: 6px 12px;
            cursor: pointer;
            background: -webkit-linear-gradient(right, #21d4fd, #b721ff, #21d4fd, #b721ff);
            width: 45%;
            border-radius: 12px;
        }
    
        p {
            color: white !important;
            font-size: 16px;
        }
    
        #output {
            font-size: 10px;
        }
    
        .hide {
            display: none;
        }
    
        .show {
            display: block;
        }
    </style>
    <!--===============================================================================================-->
</head>

<body style="background-color: #61298c;color: white;">
    <div id="cover-spin"></div>
    <div class="main-container" id="record-page"
        style="position: relative;top: 10%;text-align: center;font-size: xx-large;">
        <div class="" style="padding: 19px;
    font-size: x-large;">

            <span>RESPONSE YOUR RECORD</span>
        </div>
        <div class="greeting" style="padding: 39px;">
            <p> Good Morning Surabhi.</p>
            <p>Please have a seat</p>
        </div>
        <div class="vide-header">
            <p>Record a video/audio of your pitch not
                exceeding a total of 1 minute.</p>
        </div>
        <div class="record-video">
            <div class="start-now" style="margin-top: 54%;">
                <p style="font-size: 1.2em;margin-top: -24%;position: absolute;margin-left: 32%;">Record</p>
                <label class="custom-file-upload">
                    <input id="filePoster" type="file" accept="video/mp4,video/x-m4v,video/*" capture="user">
                    <i class="fa fa-video-camera"></i>
                </label>
                <label class="custom-file-upload">
                    <!-- <input type="file" accept="audio/*" id="recorder"> -->
                    <!-- <i class="fa fa-microphone" ></i> -->
                    <i class="fa fa-microphone" onclick="start()" id="record"></i>
                    <i class="fa fa-microphone-slash" id="stopRecord" style="display: none;"><i
                            class="fa fa-circle text-danger Blink"></i></i>
                </label>
                </label>

                <!-- <audio id=recordedAudio></audio> -->
                <span id="action" style="font-size: 12px;"></span>
                <div id="output" class="hide"></div>
            </div>

        </div>
    </div>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script>
    var input = document.getElementById('filePoster');
    input.addEventListener('change', (ev) => {
        $('#cover-spin').show(0)
        var data = {
            title: input.files[0].name,
            description: 'Mobile recorded video',
            file: input.files[0]
        }
        getAccessToken(data);
    })
</script>

<script>
    var accessToken;
    function start() {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                rec = new MediaRecorder(stream);
                $(record).css('display', 'none');
                $(stopRecord).css('display', 'inline-block');
                audioChunks = [];
                rec.start();
                rec.ondataavailable = e => {
                    // add stream data to chunks
                    audioChunks.push(e.data);
                    // if recorder is 'inactive' then recording has finished
                    if (rec.state == 'inactive') {
                        const blob = new Blob(audioChunks, { type: 'audio/wav' });
                        var audioData = {
                            title: "audio",
                            description: "Recorded audio",
                            file: new File([blob], 'recorded.wav', {type:"audio/wav"})
                        }
                        $('#cover-spin').show(0)
                        getAccessToken(audioData);
                    }
                };
            });



        stopRecord.onclick = e => {

            $(record).css('display', 'inline-block');
            $(stopRecord).css('display', 'none');
            rec.stop();
        }
    }
    function getAccessToken(Formdata) {
        var data = {
            "apiKey": "cef7afbb-68e5-43d1-9cd5-468b2f39b674",
            "apiSecret": "SVVTZEY-D3JM7M9-KKAMD2V-5WWVCX5",
            "userId": "jagadish.pujari@ilimi.in"
        }
        $.ajax({
            url: 'https://api.marsview.ai/cb/v1/auth/create_access_token',
            type: 'POST',
            data: data,
            success: function (response) {
                accessToken = response.data.accessToken;
                sendData(Formdata);
            },
            error: function (err) {
                toastr.error('Please login again')
            }
        });
    }
    //  var accessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJqYWd1aGlyZW1hdGg2MkBnbWFpbC5jb20iLCJpYXQiOjE2NDQ4MzEzNDgsImV4cCI6MTY0NDgzNDk0OH0.zP_-wIWIjJ8mrWBNl07u8EJWFdqd0UNg5CCgeXBLN8A';
    function sendData(data) {
        var formData = new FormData();
        formData.append('file', data.file);
        formData.append('title', data.title);
        formData.append('description', data.description);
        formData.append("userId", "jagadish.pujari@ilimi.in")
        $.ajax({
            url: 'https://api.marsview.ai/cb/v1/conversation/save_file',
            type: 'POST',
            data: formData,
            headers: {
                'Authorization': 'Bearer ' + accessToken,
            },
            processData: false,
            contentType: false,
            crossOrigin: true,
            success: function (response) {
                toastr.success('Video saved successfully, transaction ID is', response.data.txnId)
                uploadRequest(response.data.txnId)
            },
            error: function (err) {
                $('#cover-spin').hide(0)
                toastr.error('Failed!!!', err.responseJSON.message)
            }
        });
    }

    function uploadRequest(txnId) {
        var requestBody = {
            "txnId": txnId,
            "enableModels": [
                {
                    "modelType": "speech_to_text",
                    "modelConfig": {
                        "automatic_punctuation": true,
                        "custom_vocabulary": ["Marsview", "Communication"],
                        "speaker_seperation": {
                            "num_speakers": 2
                        },
                        "enableKeywords": true
                    }
                },
                {
                    "modelType": "emotion_analysis"
                },
                {
                    "modelType": "sentiment_analysis"
                },
                {
                    "modelType": "speech_type_analysis"
                },
                {
                    "modelType": "action_items",
                    "modelConfig": {
                        "priority": 1
                    }
                },
                {
                    "modelType": "question_response",
                    "modelConfig": {
                        "quality": 1
                    }
                },
                {
                    "modelType": "extractive_summary"
                },
                {
                    "modelType": "meeting_topics"
                },
                {
                    "modelType": "screengrabs",
                    "modelConfig": {
                        "ocr": {
                            "enable": true
                        }
                    }
                },
                {
                    "modelType": "screen_activity"
                }

            ]
        }
        console.log("REQIUEST", requestBody)
        $.ajax({
            url: 'https://api.marsview.ai/cb/v1/conversation/compute',
            type: 'POST',
            data: requestBody,
            headers: {
                'Authorization': 'Bearer ' + accessToken,
            },
            crossOrigin: true,
            success: function (response) {
                toastr.success('Your video is sent for analytics')
                getMetadata(txnId)
            },
            error: function (err) {
                $('#cover-spin').hide(0)
                toastr.error('Something went wrong!!!')
            }
        });
    }

    function getMetadata(txnId) {
        $.ajax({
            url: 'https://api.marsview.ai/cb/v1/conversation/fetch_metadata/' + txnId,
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + accessToken,
            },
            crossOrigin: true,
            success: function (response) {
                $('#cover-spin').hide(0)
                var userTxnIds = localStorage.getItem('userTxnIds');
                if(userTxnIds && userTxnIds.length > 0){
                    let temp = JSON.parse(userTxnIds);
                    temp.push(txnId);
                    localStorage.setItem('userTxnIds', JSON.stringify(temp));
                }else{
                    var userTxnIds = [];
                    userTxnIds.push(txnId);
                    localStorage.setItem('userTxnIds', JSON.stringify(userTxnIds));
                }
                // location.href = 'ai_code.html?txnId=' + txnId;
                toastr.success('Success!!!', response.message)
                location.href = 'report.html';
                
            },
            error: function (err) {
                $('#cover-spin').hide(0)
                toastr.error('Failed to get Metadata', err.responseJSON.message)
            }
        });
    }
</script>

</html>